{% extends "base.html" %}

{% block title %}Familia - Family Task Manager{% endblock %}

{% block content %}
<div class="p-4 sm:ml-64">
    <div class="p-4 rounded-lg mt-14">
        <!-- Page Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white" data-i18n="family.title">Familia</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1" data-i18n="family.subtitle">Administra los miembros de tu familia</p>
            </div>
            {% if current_user and current_user.role|lower == 'parent' %}
            <button data-modal-target="invite-member-modal" data-modal-toggle="invite-member-modal" 
                    class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                <i class="fas fa-user-plus mr-2"></i>
                <span data-i18n="family.invite">Invitar Miembro</span>
            </button>
            {% endif %}
        </div>

        <!-- Family Members Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            {% if members %}
                {% for member in members %}
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center">
                            <!-- Avatar -->
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold mr-4">
                                {{ member.name[0].upper() }}
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ member.name }}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ member.email }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Role Badge -->
                    <div class="mb-3">
                        {% if member.role|lower == 'parent' %}
                        <span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-purple-900 dark:text-purple-300">
                            <i class="fas fa-crown mr-1"></i>
                            <span data-i18n="family.role.parent">Padre/Madre</span>
                        </span>
                        {% elif member.role|lower == 'teen' %}
                        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">
                            <i class="fas fa-user-graduate mr-1"></i>
                            <span data-i18n="family.role.teen">Adolescente</span>
                        </span>
                        {% elif member.role|lower == 'child' %}
                        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">
                            <i class="fas fa-child mr-1"></i>
                            <span data-i18n="family.role.child">Niño/a</span>
                        </span>
                        {% endif %}
                    </div>
                    
                    <!-- Points -->
                    <div class="flex items-center justify-between mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-star text-yellow-400 mr-2"></i>
                            <span class="text-2xl font-bold text-gray-900 dark:text-white">{{ member.points or 0 }}</span>
                            <span class="text-gray-600 dark:text-gray-400 ml-2" data-i18n="family.points">puntos</span>
                        </div>
                    </div>
                    
                    <!-- Member Stats -->
                    <div class="grid grid-cols-3 gap-2 mb-4 text-center text-sm">
                        <div class="bg-green-50 dark:bg-green-900/20 rounded p-2">
                            <p class="font-semibold text-green-600 dark:text-green-400">{{ member.completed_tasks or 0 }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="family.stats.tasks">Tareas</p>
                        </div>
                        <div class="bg-purple-50 dark:bg-purple-900/20 rounded p-2">
                            <p class="font-semibold text-purple-600 dark:text-purple-400">{{ member.redeemed_rewards or 0 }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="family.stats.rewards">Premios</p>
                        </div>
                        <div class="bg-red-50 dark:bg-red-900/20 rounded p-2">
                            <p class="font-semibold text-red-600 dark:text-red-400">{{ member.active_consequences or 0 }}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400" data-i18n="family.stats.consequences">Sanciones</p>
                        </div>
                    </div>
                    
                    <!-- Action Buttons (Parents only) -->
                    {% if current_user and current_user.role == 'PARENT' and member.id != current_user.id %}
                    <div class="flex gap-2">
                        <button data-modal-target="edit-member-modal-{{ member.id }}" data-modal-toggle="edit-member-modal-{{ member.id }}"
                                class="flex-1 text-blue-700 hover:text-white border border-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-blue-500 dark:text-blue-500 dark:hover:text-white dark:hover:bg-blue-500 dark:focus:ring-blue-800">
                            <i class="fas fa-edit mr-1"></i>
                            <span data-i18n="family.edit">Editar</span>
                        </button>
                        <button data-modal-target="adjust-points-modal-{{ member.id }}" data-modal-toggle="adjust-points-modal-{{ member.id }}"
                                class="flex-1 text-green-700 hover:text-white border border-green-700 hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-4 py-2 dark:border-green-500 dark:text-green-500 dark:hover:text-white dark:hover:bg-green-500 dark:focus:ring-green-800">
                            <i class="fas fa-coins mr-1"></i>
                            <span data-i18n="family.adjust_points">Ajustar</span>
                        </button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-users text-6xl text-gray-400 dark:text-gray-600 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2" data-i18n="family.no_members">No hay miembros en la familia</h3>
                    <p class="text-gray-600 dark:text-gray-400" data-i18n="family.no_members_desc">Invita a tu familia para comenzar</p>
                </div>
            {% endif %}
        </div>

        <!-- Family Code Section (Parents only) -->
        {% if current_user and current_user.role == 'PARENT' and current_user.family %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4" data-i18n="family.invite_code_title">Código de Invitación</h2>
            <p class="text-gray-600 dark:text-gray-400 mb-4" data-i18n="family.invite_code_desc">Comparte este código con tu familia para que se unan</p>
            <div class="flex items-center gap-3">
                <div class="flex-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-4 font-mono text-2xl text-center text-gray-900 dark:text-white">
                    {{ current_user.family.invite_code or 'N/A' }}
                </div>
                <button onclick="copyInviteCode()" 
                        class="text-blue-700 hover:text-white border border-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-4 dark:border-blue-500 dark:text-blue-500 dark:hover:text-white dark:hover:bg-blue-500 dark:focus:ring-blue-800">
                    <i class="fas fa-copy mr-2"></i>
                    <span data-i18n="family.copy_code">Copiar</span>
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Invite Member Modal (Parents only) -->
{% if current_user and current_user.role|lower == 'parent' %}
<div id="invite-member-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white" data-i18n="family.invite">Invitar Miembro</h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="invite-member-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 md:p-5">
                <p class="text-gray-600 dark:text-gray-400 mb-4" data-i18n="family.invite_instructions">
                    Los nuevos miembros deben registrarse usando el código de invitación de tu familia
                </p>
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <p class="text-sm text-blue-800 dark:text-blue-300 mb-2" data-i18n="family.share_code">Comparte este código:</p>
                    <div class="flex items-center gap-2">
                        <code class="flex-1 bg-white dark:bg-gray-800 rounded px-3 py-2 text-lg font-mono text-gray-900 dark:text-white">
                            {{ current_user.family.invite_code or 'N/A' }}
                        </code>
                        <button onclick="copyInviteCode()" class="text-blue-700 hover:text-blue-900 dark:text-blue-400">
                            <i class="fas fa-copy text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function copyInviteCode() {
    const code = '{{ current_user.family.invite_code if current_user and current_user.family else "" }}';
    navigator.clipboard.writeText(code).then(() => {
        alert('Código copiado al portapapeles');
    });
}
</script>
{% endblock %}
