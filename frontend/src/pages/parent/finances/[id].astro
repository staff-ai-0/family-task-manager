---
import Layout from "../../../layouts/Layout.astro";
import BottomNav from "../../../components/BottomNav.astro";
import { apiFetch } from "../../../lib/api";
import { t } from "../../../lib/i18n";

const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");
const lang = Astro.cookies.get("lang")?.value ?? "en";

const { data: user } = await apiFetch<any>("/api/auth/me", { token });
if (!user) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}
if (user.role !== "parent") return Astro.redirect("/dashboard");

const { id } = Astro.params;
const urlParams = new URL(Astro.request.url).searchParams;
const categoryName = urlParams.get("name") || "Category";

let transactions = [];
let accounts = [];
let errorMsg = null;
let successMsg = null;

const API_SERVER = "http://127.0.0.1:5007";

// Handle Add Transaction POST
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const amount = formData.get("amount");
        const account_id = formData.get("account_id");
        const notes = formData.get("notes") || "";
        const date =
            formData.get("date") || new Date().toISOString().split("T")[0];
        const payee = formData.get("payee") || "Family Task Manager";

        const payload = {
            account_id,
            category_id: id,
            amount: -Math.abs(parseFloat(amount as string)), // Expenses are negative
            notes,
            date,
            payee_name: payee,
        };

        const addResp = await fetch(`${API_SERVER}/api/finance/transactions`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
        });

        if (addResp.ok) {
            successMsg =
                lang === "es"
                    ? "Transacci√≥n a√±adida con √©xito"
                    : "Transaction added successfully";
        } else {
            const err = await addResp.json();
            errorMsg = err.detail || "Error adding transaction";
        }
    } catch (e: any) {
        errorMsg = e.message;
    }
}

// Fetch Accounts (for the dropdown)
try {
    const sumResp = await fetch(`${API_SERVER}/api/finance/summary`);
    if (sumResp.ok) {
        const sumData = await sumResp.json();
        accounts = sumData.accounts || [];
    }
} catch (e) {
    console.error("Failed to fetch accounts", e);
}

// Fetch Category Transactions
try {
    const txResp = await fetch(
        `${API_SERVER}/api/finance/categories/${id}/transactions`,
    );
    if (txResp.ok) {
        const txData = await txResp.json();
        transactions = txData.transactions || [];
    }
} catch (e) {
    console.error("Failed to fetch transactions", e);
}
---

<Layout
    title={`${categoryName} - ${lang === "es" ? "Finanzas Familiares" : "Family Finances"} - Family Task Manager`}
>
    <div class="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col pb-24">
        <header
            class="bg-gradient-to-br from-emerald-700 to-teal-600 text-white pt-12 pb-6 px-6 shadow-md rounded-b-3xl"
        >
            <a
                href="/parent/finances"
                class="text-emerald-200 text-sm flex items-center gap-1 mb-3"
            >
                <svg
                    class="h-4 w-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
                {lang === "es" ? "Volver a Finanzas" : "Back to Finances"}
            </a>
            <div>
                <h1 class="text-2xl font-bold">{categoryName}</h1>
                <p class="text-emerald-200 text-sm">
                    {
                        lang === "es"
                            ? "Historial de categor√≠a"
                            : "Category history"
                    }
                </p>
            </div>
        </header>

        <main class="flex-1 px-4 py-6 space-y-6">
            {
                successMsg && (
                    <div class="bg-emerald-50 text-emerald-800 p-4 rounded-xl text-sm border border-emerald-200">
                        ‚úÖ {successMsg}
                    </div>
                )
            }

            {
                errorMsg && (
                    <div class="bg-red-50 text-red-800 p-4 rounded-xl text-sm border border-red-200">
                        ‚ùå {errorMsg}
                    </div>
                )
            }

            <!-- Add Transaction Form -->
            <section
                class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100"
            >
                <h2 class="font-bold text-slate-800 mb-4">
                    {lang === "es" ? "A√±adir Gasto" : "Add Expense"}
                </h2>
                <form method="POST" class="space-y-4">
                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 mb-1"
                            >{lang === "es" ? "Monto" : "Amount"} ($)</label
                        >
                        <input
                            type="number"
                            step="0.01"
                            min="0.01"
                            name="amount"
                            required
                            placeholder="0.00"
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all placeholder:text-slate-400 font-medium"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 mb-1"
                            >{
                                lang === "es"
                                    ? "Cuenta (Origen de fondos)"
                                    : "Account (Source of funds)"
                            }</label
                        >
                        <select
                            name="account_id"
                            required
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none text-slate-700 font-medium appearance-none"
                        >
                            {
                                accounts.map((acc) => (
                                    <option value={acc.id}>
                                        {acc.name} (${acc.balance})
                                    </option>
                                ))
                            }
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 mb-1"
                                >{lang === "es" ? "Fecha" : "Date"}</label
                            >
                            <input
                                type="date"
                                name="date"
                                required
                                defaultValue={new Date()
                                    .toISOString()
                                    .split("T")[0]}
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-slate-700"
                            />
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 mb-1"
                                >{
                                    lang === "es" ? "Lugar / Payee" : "Payee"
                                }</label
                            >
                            <input
                                type="text"
                                name="payee"
                                required
                                placeholder="Walmart, Oxxo..."
                                class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-slate-700"
                            />
                        </div>
                    </div>

                    <div>
                        <label
                            class="block text-xs font-semibold text-slate-500 mb-1"
                            >{
                                lang === "es"
                                    ? "Notas (Opcional)"
                                    : "Notes (Optional)"
                            }</label
                        >
                        <input
                            type="text"
                            name="notes"
                            placeholder={lang === "es"
                                ? "Despensa semanal"
                                : "Weekly groceries"}
                            class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-slate-700"
                        />
                    </div>

                    <button
                        type="submit"
                        class="w-full py-4 mt-2 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-xl transition-all shadow-md active:scale-[0.98]"
                    >
                        {lang === "es" ? "Guardar Gasto" : "Save Expense"}
                    </button>
                </form>
            </section>

            <!-- Recent Transactions -->
            <section>
                <h2 class="font-bold text-slate-800 mb-4 px-1">
                    {
                        lang === "es"
                            ? "Transacciones Recientes"
                            : "Recent Transactions"
                    }
                </h2>

                {
                    transactions.length === 0 ? (
                        <div class="text-center py-8 bg-slate-100 rounded-2xl border-2 border-dashed border-slate-200">
                            <span class="text-3xl mb-2 block">üìù</span>
                            <p class="text-slate-500 text-sm">
                                {lang === "es"
                                    ? "No hay transacciones en esta categor√≠a."
                                    : "No transactions in this category."}
                            </p>
                        </div>
                    ) : (
                        <div class="space-y-3">
                            {transactions.map((tx: any) => (
                                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class={`w-12 h-12 rounded-full flex items-center justify-center ${tx.amount < 0 ? "bg-red-50 text-red-600" : "bg-emerald-50 text-emerald-600"}`}
                                        >
                                            <svg
                                                class="h-6 w-6"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                {tx.amount < 0 ? (
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                                                    />
                                                ) : (
                                                    <path
                                                        stroke-linecap="round"
                                                        stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                                                    />
                                                )}
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-800">
                                                {tx.payee_name ||
                                                    (lang === "es"
                                                        ? "Sin lugar"
                                                        : "Unknown")}
                                            </h4>
                                            <p class="text-xs text-slate-500 mt-0.5">
                                                {tx.date} ‚Ä¢{" "}
                                                {tx.account_name || "Account"}
                                            </p>
                                            {tx.notes && (
                                                <p class="text-xs text-slate-400 italic mt-0.5">
                                                    {tx.notes}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                    <div
                                        class={`font-bold ${tx.amount < 0 ? "text-slate-800" : "text-emerald-600"}`}
                                    >
                                        ${Math.abs(tx.amount).toFixed(2)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )
                }
            </section>
        </main>

        <BottomNav active="parent" role={user.role} lang={lang} />
    </div>
</Layout>
