---
import Layout from "../layouts/Layout.astro";
import BottomNav from "../components/BottomNav.astro";
import { apiFetch } from "../lib/api";
import { t } from "../lib/i18n";

const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");
const lang = Astro.cookies.get("lang")?.value ?? "en";

let successMsg = "";
let errorMsg = "";

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const action = data.get("action");
    if (action === "change_password") {
        const { ok, error } = await apiFetch("/api/auth/password", {
            method: "PUT",
            token,
            body: JSON.stringify({
                current_password: data.get("current_password"),
                new_password: data.get("new_password"),
            }),
        });
        successMsg = ok ? t(lang, "profile_password_success") : "";
        errorMsg = ok ? "" : error || t(lang, "profile_password_error");
    } else if (action === "change_lang") {
        const newLang = data.get("preferred_lang") as string;
        const { ok } = await apiFetch("/api/auth/me", {
            method: "PUT",
            token,
            body: JSON.stringify({ preferred_lang: newLang }),
        });
        if (ok) {
            Astro.cookies.set("lang", newLang, { path: "/", maxAge: 60 * 60 * 24 * 365 });
            successMsg = t(newLang, "profile_lang_saved");
        } else {
            errorMsg = t(lang, "profile_lang_error");
        }
    }
}

const [{ data: user }, { data: pointsSummary }, { data: consequencesRaw }] =
    await Promise.all([
        apiFetch<any>("/api/auth/me", { token }),
        apiFetch<any>("/api/users/me/points", { token }),
        apiFetch<any[]>("/api/consequences/me/active", { token }),
    ]);
if (!user) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}
const consequences: any[] = Array.isArray(consequencesRaw)
    ? consequencesRaw
    : [];
---

<Layout title={`${t(lang, "profile_title")} - Family Task Manager`}>
    <div class="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col pb-24">
        <header
            class="bg-gradient-to-br from-violet-600 to-indigo-600 text-white pt-12 pb-8 px-6 rounded-b-3xl shadow-md"
        >
            <div class="flex items-center gap-4">
                <div
                    class="h-16 w-16 rounded-full bg-white/20 border-2 border-white flex items-center justify-center text-3xl font-bold"
                >
                    {user.name.charAt(0).toUpperCase()}
                </div>
                <div>
                    <h1 class="text-2xl font-bold">{user.name}</h1>
                    <p class="text-indigo-200 text-sm">{user.email}</p>
                    <span
                        class="inline-block mt-1 px-2.5 py-0.5 text-xs font-semibold rounded-full bg-white/20 border border-white/30"
                        >{user.role}</span
                    >
                </div>
            </div>
        </header>

        <main class="flex-1 px-4 py-6 space-y-6">
            {
                successMsg && (
                    <div class="p-3 bg-green-50 border border-green-200 text-green-700 text-sm rounded-xl">
                        {successMsg}
                    </div>
                )
            }
            {
                errorMsg && (
                    <div class="p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-xl">
                        {errorMsg}
                    </div>
                )
            }

            {
                pointsSummary && (
                    <section class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">
                            {t(lang, "profile_points_summary")}
                        </h2>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="bg-green-50 rounded-xl p-3">
                                <p class="text-2xl font-extrabold text-green-600">
                                    {pointsSummary.total_earned ?? 0}
                                </p>
                                <p class="text-xs text-green-700 font-medium mt-0.5">
                                    {t(lang, "profile_earned")}
                                </p>
                            </div>
                            <div class="bg-red-50 rounded-xl p-3">
                                <p class="text-2xl font-extrabold text-red-500">
                                    {pointsSummary.total_spent ?? 0}
                                </p>
                                <p class="text-xs text-red-600 font-medium mt-0.5">
                                    {t(lang, "profile_spent")}
                                </p>
                            </div>
                            <div class="bg-amber-50 rounded-xl p-3">
                                <p class="text-2xl font-extrabold text-amber-600">
                                    {pointsSummary.current_balance ??
                                        user.points}
                                </p>
                                <p class="text-xs text-amber-700 font-medium mt-0.5">
                                    {t(lang, "profile_balance")}
                                </p>
                            </div>
                        </div>
                    </section>
                )
            }

            {
                consequences.length > 0 && (
                    <section class="bg-white rounded-2xl p-5 shadow-sm border border-rose-100">
                        <h2 class="text-lg font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-rose-500 inline-block" />
                            {t(lang, "profile_active_consequences")}
                        </h2>
                        <div class="space-y-3">
                            {consequences.map((c: any) => (
                                <div class="flex items-start gap-3 p-3 bg-rose-50 rounded-xl border border-rose-100">
                                    <div class="flex-1">
                                        <p class="font-semibold text-slate-700 text-sm">
                                            {c.title || c.name || "—"}
                                        </p>
                                        {c.description && (
                                            <p class="text-xs text-slate-500 mt-0.5">
                                                {c.description}
                                            </p>
                                        )}
                                    </div>
                                    {c.due_date && (
                                        <span class="text-xs text-rose-600 font-medium flex-shrink-0">
                                            {t(lang, "profile_until")}{" "}
                                            {new Date(
                                                c.due_date,
                                            ).toLocaleDateString()}
                                        </span>
                                    )}
                                </div>
                            ))}
                        </div>
                    </section>
                )
            }

            <!-- Language Preference -->
            <section class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100">
                <h2 class="text-lg font-bold text-slate-800 mb-4">
                    {t(lang, "profile_preferred_lang")}
                </h2>
                <form method="POST" class="flex items-center gap-3">
                    <input type="hidden" name="action" value="change_lang" />
                    <select
                        name="preferred_lang"
                        class="flex-1 px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary-500 outline-none text-sm bg-white"
                    >
                        <option value="en" selected={user.preferred_lang === "en"}>{t(lang, "profile_lang_en")}</option>
                        <option value="es" selected={user.preferred_lang === "es"}>{t(lang, "profile_lang_es")}</option>
                    </select>
                    <button
                        type="submit"
                        class="px-5 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm"
                    >
                        {t(lang, "pt_save")}
                    </button>
                </form>
            </section>

            <section
                class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100"
            >
                <h2 class="text-lg font-bold text-slate-800 mb-4">
                    {t(lang, "profile_change_password")}
                </h2>
                <form method="POST" class="space-y-4">
                    <input
                        type="hidden"
                        name="action"
                        value="change_password"
                    />
                    <div>
                        <label
                            for="current_password"
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >{t(lang, "profile_current_password")}</label
                        >
                        <input
                            type="password"
                            id="current_password"
                            name="current_password"
                            required
                            placeholder="••••••••"
                            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary-500 outline-none text-sm"
                        />
                    </div>
                    <div>
                        <label
                            for="new_password"
                            class="block text-sm font-medium text-slate-700 mb-1"
                            >{t(lang, "profile_new_password")}</label
                        >
                        <input
                            type="password"
                            id="new_password"
                            name="new_password"
                            required
                            placeholder="••••••••"
                            minlength={8}
                            class="w-full px-4 py-2.5 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary-500 outline-none text-sm"
                        />
                    </div>
                    <button
                        type="submit"
                        class="w-full py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-semibold rounded-lg transition-colors shadow-sm"
                    >
                        {t(lang, "profile_update_password")}
                    </button>
                </form>
            </section>
        </main>

        <BottomNav active="profile" role={user.role} lang={lang} />
    </div>
</Layout>
