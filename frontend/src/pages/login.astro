---
import Layout from "../layouts/Layout.astro";
import { t } from "../lib/i18n";

let error = "";
const lang = Astro.cookies.get("lang")?.value ?? "en";

if (Astro.cookies.has("access_token")) {
    return Astro.redirect("/dashboard");
}

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const email = data.get("email");
        const password = data.get("password");

        const apiUrl = process.env.API_BASE_URL || "http://localhost:8002";
        const response = await fetch(`${apiUrl}/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
        });

        if (response.ok) {
            const result = await response.json();
            Astro.cookies.set("access_token", result.access_token, {
                path: "/",
                httpOnly: true,
                sameSite: "lax",
                maxAge: 60 * 60 * 24 * 7,
            });
            return Astro.redirect("/dashboard");
        } else {
            const errData = await response.json();
            error = errData.detail || t(lang, "login_error_invalid");
        }
    } catch (e) {
        error = t(lang, "login_error_server");
    }
}
---

<Layout title={`${t(lang, "login_submit")} - Family Task Manager`}>
    <main class="flex min-h-screen flex-col items-center justify-center p-4">
        <div
            class="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden p-8"
        >
            <div class="mb-8 text-center">
                <h1
                    class="text-3xl font-bold tracking-tight text-slate-900 mb-2"
                >
                    {t(lang, "login_welcome")}
                </h1>
                <p class="text-slate-500">{t(lang, "login_subtitle")}</p>
            </div>

            {
                error && (
                    <div class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm">
                        {error}
                    </div>
                )
            }

            <form method="POST" class="space-y-6">
                <div>
                    <label
                        for="email"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >{t(lang, "login_email")}</label
                    >
                    <input
                        type="email"
                        id="email"
                        name="email"
                        required
                        placeholder="parent@demo.com"
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-shadow"
                    />
                </div>
                <div>
                    <label
                        for="password"
                        class="block text-sm font-medium text-slate-700 mb-1"
                        >{t(lang, "login_password")}</label
                    >
                    <input
                        type="password"
                        id="password"
                        name="password"
                        required
                        placeholder="••••••••"
                        class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-shadow"
                    />
                </div>
                <button
                    type="submit"
                    class="w-full flex justify-center py-3 px-4 rounded-lg text-white font-medium bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors shadow-sm"
                >
                    {t(lang, "login_submit")}
                </button>
            </form>

            <!-- Language toggle on login page -->
            <form
                method="POST"
                action="/api/lang"
                class="mt-4 flex justify-center"
            >
                <input
                    type="hidden"
                    name="lang"
                    value={lang === "es" ? "en" : "es"}
                />
                <button
                    type="submit"
                    class="text-xs text-slate-400 hover:text-indigo-500 flex items-center gap-1 transition-colors"
                >
                    <svg
                        class="h-3.5 w-3.5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
                        ></path>
                    </svg>
                    {lang === "es" ? "Switch to English" : "Cambiar a Español"}
                </button>
            </form>

            <div class="mt-8 text-center">
                <p class="text-sm text-slate-500">
                    {t(lang, "login_demo")}:<br />
                    mom@demo.com / password123<br />
                    emma@demo.com / password123
                </p>
            </div>
        </div>
    </main>
</Layout>
