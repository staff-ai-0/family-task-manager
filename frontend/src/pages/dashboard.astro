---
import Layout from "../layouts/Layout.astro";
import BottomNav from "../components/BottomNav.astro";
import { apiFetch } from "../lib/api";
import { t } from "../lib/i18n";

const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");
const lang = Astro.cookies.get("lang")?.value ?? "en";

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const action = data.get("action");

    if (action === "logout") {
        Astro.cookies.delete("access_token", { path: "/" });
        return Astro.redirect("/login");
    }

    if (action === "complete") {
        const assignmentId = data.get("assignment_id");
        if (assignmentId) {
            const { ok, error } = await apiFetch(`/api/task-assignments/${assignmentId}/complete`, {
                method: "PATCH",
                token,
            });
            if (!ok) {
                // Store error in cookie for display after redirect
                Astro.cookies.set("flash_error", error || (t(lang, "dashboard_complete_error") as string), { path: "/" });
            }
        }
        return Astro.redirect("/dashboard");
    }
}

const { data: user, ok: userOk } = await apiFetch<any>("/api/auth/me", { token });
if (!userOk) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}

// Fetch daily progress (includes assignments with template details + gating status)
const { data: progress } = await apiFetch<any>("/api/task-assignments/progress", { token });

const requiredTotal = progress?.required_total ?? 0;
const requiredCompleted = progress?.required_completed ?? 0;
const bonusUnlocked = progress?.bonus_unlocked ?? false;
const bonusTotal = progress?.bonus_total ?? 0;
const bonusCompleted = progress?.bonus_completed ?? 0;
const assignments: any[] = progress?.assignments ?? [];

const requiredAssignments = assignments.filter((a: any) => !a.template_is_bonus);
const bonusAssignments = assignments.filter((a: any) => a.template_is_bonus);

const pendingRequired = requiredAssignments.filter((a: any) => a.status === "pending");
const completedRequired = requiredAssignments.filter((a: any) => a.status === "completed");
const pendingBonus = bonusAssignments.filter((a: any) => a.status === "pending");
const completedBonus = bonusAssignments.filter((a: any) => a.status === "completed");

const allDone = requiredCompleted >= requiredTotal && bonusCompleted >= bonusTotal && (requiredTotal + bonusTotal) > 0;
const noTasks = requiredTotal === 0 && bonusTotal === 0;

const progressPercent = requiredTotal > 0 ? Math.round((requiredCompleted / requiredTotal) * 100) : 100;

const flash = Astro.cookies.get("flash")?.value;
if (flash) Astro.cookies.delete("flash", { path: "/" });
const flashError = Astro.cookies.get("flash_error")?.value;
if (flashError) Astro.cookies.delete("flash_error", { path: "/" });
---

<Layout title={`${t(lang, "dashboard_page_title")} - Family Task Manager`}>
    <div class="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col pb-24">
        <header class="bg-primary-600 text-white pt-12 pb-6 px-6 rounded-b-3xl shadow-md">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-primary-100 text-sm font-medium">{t(lang, "dashboard_hello")}</p>
                    <h1 class="text-2xl font-bold">{user.name}</h1>
                </div>
                <div class="h-12 w-12 rounded-full bg-primary-500 border-2 border-white flex items-center justify-center text-lg font-bold">
                    {user.name.charAt(0).toUpperCase()}
                </div>
            </div>
            <div class="bg-white/20 backdrop-blur-md rounded-2xl p-4 flex items-center justify-between border border-white/30">
                <div>
                    <p class="text-primary-50 text-xs font-semibold uppercase tracking-wider mb-1">
                        {t(lang, "dashboard_my_points")}
                    </p>
                    <p class="text-3xl font-extrabold tracking-tight">{user.points}</p>
                </div>
                <div class="bg-yellow-400 p-3 rounded-xl shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                </div>
            </div>
        </header>

        {flash && (
            <div class="mx-4 mt-4 p-3 bg-green-50 border border-green-200 text-green-700 text-sm rounded-xl">
                {flash}
            </div>
        )}
        {flashError && (
            <div class="mx-4 mt-4 p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-xl">
                {flashError}
            </div>
        )}

        <main class="flex-1 px-4 py-6">
            <!-- Today header + Progress bar -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-2 px-1">
                    <h2 class="text-xl font-bold text-slate-800 tracking-tight">
                        {t(lang, "dashboard_today")}
                    </h2>
                    {requiredTotal > 0 && (
                        <span class="text-sm font-medium text-slate-500">
                            {t(lang, "dashboard_progress")(requiredCompleted, requiredTotal)}
                        </span>
                    )}
                </div>
                {requiredTotal > 0 && (
                    <div class="w-full bg-slate-200 rounded-full h-2.5">
                        <div
                            class="bg-primary-500 h-2.5 rounded-full transition-all duration-500"
                            style={`width: ${progressPercent}%`}
                        ></div>
                    </div>
                )}
            </div>

            <!-- No tasks state -->
            {noTasks && (
                <div class="bg-white rounded-2xl p-8 text-center border border-slate-100 shadow-sm">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <p class="text-slate-500 text-sm">{t(lang, "dashboard_no_assignments")}</p>
                </div>
            )}

            <!-- All done state -->
            {allDone && !noTasks && (
                <div class="bg-white rounded-2xl p-8 text-center border border-slate-100 shadow-sm mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700">{t(lang, "dashboard_all_done")}</h3>
                    <p class="text-slate-500 mt-1 text-sm">{t(lang, "dashboard_all_done_subtitle")}</p>
                </div>
            )}

            <!-- Required Tasks Section -->
            {requiredTotal > 0 && (
                <div class="mb-8">
                    <div class="flex justify-between items-end mb-3 px-1">
                        <h3 class="text-lg font-bold text-slate-800">{t(lang, "dashboard_required")}</h3>
                        <span class="text-sm text-slate-500">
                            {t(lang, "dashboard_tasks_count")(pendingRequired.length)}
                        </span>
                    </div>
                    <div class="space-y-3">
                        {pendingRequired.map((a: any) => (
                            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-all flex justify-between items-center">
                                <div class="pr-4 flex-1">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">
                                        {lang === "es" && a.template_title_es ? a.template_title_es : a.template_title}
                                    </h3>
                                    <p class="text-slate-500 text-sm line-clamp-2">
                                        {(lang === "es" && a.template_description_es ? a.template_description_es : a.template_description) || "--"}
                                    </p>
                                    <div class="flex items-center gap-2 mt-3 flex-wrap">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                                            +{a.template_points} pts
                                        </span>
                                    </div>
                                </div>
                                {a.can_complete && (
                                    <form method="POST">
                                        <input type="hidden" name="action" value="complete" />
                                        <input type="hidden" name="assignment_id" value={a.id} />
                                        <button
                                            type="submit"
                                            class="h-12 w-12 rounded-full bg-slate-100 text-primary-600 flex items-center justify-center hover:bg-primary-600 hover:text-white transition-colors active:scale-95 flex-shrink-0 shadow-sm"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                        </button>
                                    </form>
                                )}
                            </div>
                        ))}
                    </div>

                    <!-- Completed required tasks (collapsible) -->
                    {completedRequired.length > 0 && (
                        <details class="mt-3 group">
                            <summary class="flex justify-between items-center px-1 mb-2 cursor-pointer list-none">
                                <span class="text-sm font-medium text-slate-500">{t(lang, "dashboard_completed")}</span>
                                <span class="text-xs text-slate-400">
                                    {t(lang, "dashboard_tasks_count")(completedRequired.length)}
                                </span>
                            </summary>
                            <div class="space-y-2">
                                {completedRequired.map((a: any) => (
                                    <div class="bg-white/60 rounded-2xl px-5 py-3 border border-slate-100 flex items-center gap-4 opacity-70">
                                        <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                                            <svg class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="font-medium text-slate-600 line-through">
                                                {lang === "es" && a.template_title_es ? a.template_title_es : a.template_title}
                                            </p>
                                            <p class="text-xs text-slate-400">{t(lang, "dashboard_earned")(a.template_points)}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </details>
                    )}
                </div>
            )}

            <!-- Bonus Tasks Section -->
            {bonusTotal > 0 && (
                <div>
                    <div class="flex justify-between items-end mb-3 px-1">
                        <h3 class="text-lg font-bold text-amber-700">{t(lang, "dashboard_bonus")}</h3>
                        <span class="text-sm text-slate-500">
                            {t(lang, "dashboard_tasks_count")(pendingBonus.length)}
                        </span>
                    </div>

                    {!bonusUnlocked ? (
                        <!-- Locked state -->
                        <div class="bg-amber-50 rounded-2xl p-5 border border-amber-200 text-center">
                            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="w-6 h-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                </svg>
                            </div>
                            <p class="text-amber-700 text-sm font-medium">{t(lang, "dashboard_bonus_locked")}</p>
                            <p class="text-amber-600 text-xs mt-1">
                                {t(lang, "dashboard_progress")(requiredCompleted, requiredTotal)}
                            </p>
                        </div>
                    ) : (
                        <!-- Unlocked bonus tasks -->
                        <div>
                            <div class="mb-3 px-1">
                                <p class="text-xs text-green-600 font-medium">{t(lang, "dashboard_bonus_unlocked")}</p>
                            </div>
                            <div class="space-y-3">
                                {pendingBonus.map((a: any) => (
                                    <div class="bg-white rounded-2xl p-5 shadow-sm border border-amber-100 hover:shadow-md transition-all flex justify-between items-center">
                                        <div class="pr-4 flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h3 class="font-bold text-slate-800 text-lg">
                                                    {lang === "es" && a.template_title_es ? a.template_title_es : a.template_title}
                                                </h3>
                                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">
                                                    {t(lang, "dashboard_bonus_badge")}
                                                </span>
                                            </div>
                                            <p class="text-slate-500 text-sm line-clamp-2">
                                                {(lang === "es" && a.template_description_es ? a.template_description_es : a.template_description) || "--"}
                                            </p>
                                            <div class="flex items-center gap-2 mt-3">
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">
                                                    +{a.template_points} pts
                                                </span>
                                            </div>
                                        </div>
                                        {a.can_complete && (
                                            <form method="POST">
                                                <input type="hidden" name="action" value="complete" />
                                                <input type="hidden" name="assignment_id" value={a.id} />
                                                <button
                                                    type="submit"
                                                    class="h-12 w-12 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center hover:bg-amber-500 hover:text-white transition-colors active:scale-95 flex-shrink-0 shadow-sm"
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </button>
                                            </form>
                                        )}
                                    </div>
                                ))}
                            </div>

                            <!-- Completed bonus tasks -->
                            {completedBonus.length > 0 && (
                                <details class="mt-3 group">
                                    <summary class="flex justify-between items-center px-1 mb-2 cursor-pointer list-none">
                                        <span class="text-sm font-medium text-slate-500">{t(lang, "dashboard_completed")}</span>
                                        <span class="text-xs text-slate-400">
                                            {t(lang, "dashboard_tasks_count")(completedBonus.length)}
                                        </span>
                                    </summary>
                                    <div class="space-y-2">
                                        {completedBonus.map((a: any) => (
                                            <div class="bg-white/60 rounded-2xl px-5 py-3 border border-amber-100 flex items-center gap-4 opacity-70">
                                                <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                                                    <svg class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-slate-600 line-through">
                                                        {lang === "es" && a.template_title_es ? a.template_title_es : a.template_title}
                                                    </p>
                                                    <p class="text-xs text-slate-400">{t(lang, "dashboard_earned")(a.template_points)}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </details>
                            )}
                        </div>
                    )}
                </div>
            )}
        </main>

        <BottomNav active="tasks" role={user.role} lang={lang} />
    </div>
</Layout>
