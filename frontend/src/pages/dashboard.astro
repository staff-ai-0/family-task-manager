---
import Layout from "../layouts/Layout.astro";
import BottomNav from "../components/BottomNav.astro";
import { apiFetch } from "../lib/api";
import { t } from "../lib/i18n";

const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");
const lang = Astro.cookies.get("lang")?.value ?? "en";

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const action = data.get("action");

    if (action === "logout") {
        Astro.cookies.delete("access_token", { path: "/" });
        return Astro.redirect("/login");
    }

    if (action === "complete") {
        const taskId = data.get("task_id");
        if (taskId) {
            await apiFetch(`/api/tasks/${taskId}/complete`, {
                method: "PATCH",
                token,
            });
        }
        return Astro.redirect("/dashboard");
    }
}

const { data: user, ok: userOk } = await apiFetch<any>("/api/auth/me", {
    token,
});
if (!userOk) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}

const { data: tasksRaw } = await apiFetch<any[]>("/api/tasks", { token });
const tasks: any[] = Array.isArray(tasksRaw)
    ? tasksRaw
    : ((tasksRaw as any)?.items ?? []);
const pendingTasks = tasks.filter(
    (t: any) => t.status === "PENDING" || t.status === "IN_PROGRESS",
);
const completedTasks = tasks.filter((t: any) => t.status === "COMPLETED");

const flash = Astro.cookies.get("flash")?.value;
if (flash) Astro.cookies.delete("flash", { path: "/" });
---

<Layout title="Dashboard - Family Task Manager">
    <div class="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col pb-24">
        <header
            class="bg-primary-600 text-white pt-12 pb-6 px-6 rounded-b-3xl shadow-md"
        >
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-primary-100 text-sm font-medium">
                        {t(lang, "dashboard_hello")}
                    </p>
                    <h1 class="text-2xl font-bold">{user.name}</h1>
                </div>
                <div
                    class="h-12 w-12 rounded-full bg-primary-500 border-2 border-white flex items-center justify-center text-lg font-bold"
                >
                    {user.name.charAt(0).toUpperCase()}
                </div>
            </div>
            <div
                class="bg-white/20 backdrop-blur-md rounded-2xl p-4 flex items-center justify-between border border-white/30"
            >
                <div>
                    <p
                        class="text-primary-50 text-xs font-semibold uppercase tracking-wider mb-1"
                    >
                        {t(lang, "dashboard_my_points")}
                    </p>
                    <p class="text-3xl font-extrabold tracking-tight">
                        {user.points}
                    </p>
                </div>
                <div class="bg-yellow-400 p-3 rounded-xl shadow-inner">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-8 w-8 text-yellow-700"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
                        ></path>
                    </svg>
                </div>
            </div>
        </header>

        {
            flash && (
                <div class="mx-4 mt-4 p-3 bg-green-50 border border-green-200 text-green-700 text-sm rounded-xl">
                    {flash}
                </div>
            )
        }

        <main class="flex-1 px-4 py-6">
            <div class="flex justify-between items-end mb-4 px-1">
                <h2 class="text-xl font-bold text-slate-800 tracking-tight">
                    {t(lang, "dashboard_pending_tasks")}
                </h2>
                <span class="text-sm font-medium text-slate-500"
                    >{
                        t(lang, "dashboard_tasks_count")(pendingTasks.length)
                    }</span
                >
            </div>

            <div class="space-y-4 mb-8">
                {
                    pendingTasks.length === 0 ? (
                        <div class="bg-white rounded-2xl p-8 text-center border border-slate-100 shadow-sm">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg
                                    class="w-8 h-8 text-green-500"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M5 13l4 4L19 7"
                                    />
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-slate-700">
                                {t(lang, "dashboard_all_done")}
                            </h3>
                            <p class="text-slate-500 mt-1 text-sm">
                                {t(lang, "dashboard_all_done_subtitle")}
                            </p>
                        </div>
                    ) : (
                        pendingTasks.map((task: any) => (
                            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 hover:shadow-md transition-all flex justify-between items-center">
                                <div class="pr-4 flex-1">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">
                                        {task.title}
                                    </h3>
                                    <p class="text-slate-500 text-sm line-clamp-2">
                                        {task.description || "â€”"}
                                    </p>
                                    <div class="flex items-center gap-2 mt-3 flex-wrap">
                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-primary-100 text-primary-700">
                                            +{task.points} pts
                                        </span>
                                        {task.due_date && (
                                            <span class="text-xs text-slate-400 font-medium">
                                                {t(lang, "pt_due_date")}:{" "}
                                                {new Date(
                                                    task.due_date,
                                                ).toLocaleDateString()}
                                            </span>
                                        )}
                                    </div>
                                </div>
                                <form method="POST">
                                    <input
                                        type="hidden"
                                        name="action"
                                        value="complete"
                                    />
                                    <input
                                        type="hidden"
                                        name="task_id"
                                        value={task.id}
                                    />
                                    <button
                                        type="submit"
                                        class="h-12 w-12 rounded-full bg-slate-100 text-primary-600 flex items-center justify-center hover:bg-primary-600 hover:text-white transition-colors active:scale-95 flex-shrink-0 shadow-sm"
                                    >
                                        <svg
                                            xmlns="http://www.w3.org/2000/svg"
                                            class="h-6 w-6"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        ))
                    )
                }
            </div>

            {
                completedTasks.length > 0 && (
                    <details class="group">
                        <summary class="flex justify-between items-center px-1 mb-3 cursor-pointer list-none">
                            <h2 class="text-lg font-bold text-slate-600 tracking-tight">
                                {t(lang, "dashboard_completed")}
                            </h2>
                            <span class="text-sm text-slate-400">
                                {t(
                                    lang,
                                    "dashboard_tasks_count",
                                )(completedTasks.length)}
                            </span>
                        </summary>
                        <div class="space-y-3">
                            {completedTasks.map((task: any) => (
                                <div class="bg-white/60 rounded-2xl px-5 py-4 border border-slate-100 flex items-center gap-4 opacity-70">
                                    <div class="h-8 w-8 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                                        <svg
                                            class="h-4 w-4 text-green-600"
                                            fill="none"
                                            viewBox="0 0 24 24"
                                            stroke="currentColor"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-slate-600 line-through">
                                            {task.title}
                                        </p>
                                        <p class="text-xs text-slate-400">
                                            {t(
                                                lang,
                                                "dashboard_earned",
                                            )(task.points)}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </details>
                )
            }
        </main>

        <BottomNav active="tasks" role={user.role} lang={lang} />
    </div>
</Layout>
