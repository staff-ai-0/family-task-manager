---
/**
 * New Transaction Page
 * Form for creating a new budget transaction
 */

import Layout from "@layouts/Layout.astro";
import BottomNav from "@components/BottomNav.astro";
import { apiFetch } from "@lib/api";
import { getAccounts, getCategories, getCategoryGroups, getPayees, createTransaction } from "@lib/api/budget";

// Authentication check
const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");

const lang = Astro.cookies.get("lang")?.value ?? "en";

// Get user info
const { data: user, ok: userOk } = await apiFetch<any>("/api/auth/me", { token });
if (!userOk) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}

// Only parents can manage budget
if (user.role !== "parent") {
    return Astro.redirect("/dashboard");
}

// Handle form submission
let error: string | null = null;
let success = false;

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const accountId = formData.get("account_id") as string;
        const date = formData.get("date") as string;
        const amountStr = formData.get("amount") as string;
        const isExpense = formData.get("transaction_type") === "expense";
        const categoryId = formData.get("category_id") as string;
        const notes = formData.get("notes") as string;
        const cleared = formData.get("cleared") === "on";

        // Convert amount to cents (negative for expenses)
        let amountCents = Math.round(parseFloat(amountStr) * 100);
        if (isExpense) amountCents = -Math.abs(amountCents);

        const result = await createTransaction(token, {
            account_id: accountId,
            date,
            amount: amountCents,
            category_id: categoryId || undefined,
            notes: notes || undefined,
            cleared,
        });

        if (result.ok) {
            success = true;
            // Redirect after short delay to show success message
            return Astro.redirect("/budget/transactions");
        } else {
            error = result.error || "Error al crear transacción";
        }
    } catch (e: any) {
        error = e.message || "Error al procesar formulario";
    }
}

// Fetch form data
const { data: accounts } = await getAccounts(token, { budgetOnly: true, includeClosed: false });
const { data: categoryGroups } = await getCategoryGroups(token);
const { data: payees } = await getPayees(token);

// Get today's date for default
const today = new Date().toISOString().split('T')[0];
---

<Layout title="Nueva Transacción - Presupuesto">
    <div class="w-full max-w-md md:max-w-4xl lg:max-w-6xl mx-auto min-h-screen bg-slate-50 flex flex-col">
        <!-- Header -->
        <header class="bg-primary-600 text-white pt-12 pb-6 px-6 rounded-b-3xl shadow-md">
            <div class="flex items-center justify-between">
                <a href="/budget/transactions" class="text-white hover:text-primary-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <h1 class="text-2xl font-bold">Nueva Transacción</h1>
                <div class="w-6"></div>
            </div>
        </header>

        <!-- Form -->
        <main class="px-6 py-6 flex-grow">
            {error && (
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 mb-4">
                    <p class="font-semibold">Error</p>
                    <p class="text-sm">{error}</p>
                </div>
            )}

            {success && (
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-green-700 mb-4">
                    <p class="font-semibold">¡Transacción creada!</p>
                </div>
            )}

            <form method="POST" class="space-y-4">
                <!-- Transaction Type -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label class="block text-sm font-semibold text-slate-700 mb-3">
                        Tipo de Transacción
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative">
                            <input
                                type="radio"
                                name="transaction_type"
                                value="expense"
                                checked
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-red-500 peer-checked:bg-red-50 transition text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm font-medium text-slate-700">Gasto</span>
                            </div>
                        </label>
                        <label class="relative">
                            <input
                                type="radio"
                                name="transaction_type"
                                value="income"
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-green-500 peer-checked:bg-green-50 transition text-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span class="text-sm font-medium text-slate-700">Ingreso</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Account -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="account_id" class="block text-sm font-semibold text-slate-700 mb-2">
                        Cuenta *
                    </label>
                    <select
                        id="account_id"
                        name="account_id"
                        required
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    >
                        <option value="">Selecciona una cuenta</option>
                        {accounts?.map(account => (
                            <option value={account.id}>{account.name}</option>
                        ))}
                    </select>
                </div>

                <!-- Date -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="date" class="block text-sm font-semibold text-slate-700 mb-2">
                        Fecha *
                    </label>
                    <input
                        type="date"
                        id="date"
                        name="date"
                        value={today}
                        required
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                </div>

                <!-- Amount -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="amount" class="block text-sm font-semibold text-slate-700 mb-2">
                        Cantidad (MXN) *
                    </label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-medium">$</span>
                        <input
                            type="number"
                            id="amount"
                            name="amount"
                            step="0.01"
                            min="0"
                            required
                            placeholder="0.00"
                            class="w-full pl-8 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                        />
                    </div>
                </div>

                <!-- Category -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="category_id" class="block text-sm font-semibold text-slate-700 mb-2">
                        Categoría
                    </label>
                    <select
                        id="category_id"
                        name="category_id"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    >
                        <option value="">Sin categoría</option>
                        {categoryGroups?.map(group => (
                            <optgroup label={group.name}>
                                {group.categories.map(category => (
                                    <option value={category.id}>{category.name}</option>
                                ))}
                            </optgroup>
                        ))}
                    </select>
                </div>

                <!-- Notes -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="notes" class="block text-sm font-semibold text-slate-700 mb-2">
                        Notas
                    </label>
                    <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        placeholder="Descripción opcional..."
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    ></textarea>
                </div>

                <!-- Cleared -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input
                            type="checkbox"
                            name="cleared"
                            class="w-5 h-5 text-primary-600 border-slate-300 rounded focus:ring-2 focus:ring-primary-500"
                        />
                        <span class="text-sm font-medium text-slate-700">
                            Marcar como conciliada
                        </span>
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3 pt-4">
                    <a
                        href="/budget/transactions"
                        class="flex-1 bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-semibold hover:bg-slate-300 transition text-center"
                    >
                        Cancelar
                    </a>
                    <button
                        type="submit"
                        class="flex-1 bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition"
                    >
                        Guardar
                    </button>
                </div>
            </form>
        </main>

        <BottomNav active="parent" role={user.role} lang={lang} />
    </div>
</Layout>

<script>
    // Auto-submit on account/category change for better UX (optional)
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('form');
        const amountInput = document.getElementById('amount') as HTMLInputElement;
        
        // Focus amount field after selecting account
        document.getElementById('account_id')?.addEventListener('change', () => {
            amountInput?.focus();
        });
    });
</script>
