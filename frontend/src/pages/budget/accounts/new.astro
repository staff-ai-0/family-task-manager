---
/**
 * New Account Page
 * Form for creating a new budget account
 */

import Layout from "@layouts/Layout.astro";
import BottomNav from "@components/BottomNav.astro";
import { apiFetch } from "@lib/api";
import { createAccount } from "@lib/api/budget";

// Authentication check
const token = Astro.cookies.get("access_token")?.value;
if (!token) return Astro.redirect("/login");

const lang = Astro.cookies.get("lang")?.value ?? "en";

// Get user info
const { data: user, ok: userOk } = await apiFetch<any>("/api/auth/me", { token });
if (!userOk) {
    Astro.cookies.delete("access_token", { path: "/" });
    return Astro.redirect("/login");
}

// Only parents can manage budget
if (user.role !== "parent") {
    return Astro.redirect("/dashboard");
}

// Handle form submission
let error: string | null = null;
let success = false;

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const name = formData.get("name") as string;
        const type = formData.get("type") as "checking" | "savings" | "credit" | "investment" | "other";
        const offbudget = formData.get("offbudget") === "on";
        const notes = formData.get("notes") as string;

        const result = await createAccount(token, {
            name,
            type,
            offbudget,
            notes: notes || undefined,
        });

        if (result.ok && result.data) {
            success = true;
            // Redirect to the new account page
            return Astro.redirect(`/budget/accounts/${result.data.id}`);
        } else {
            error = result.error || (lang === "es" ? "Error al crear cuenta" : "Error creating account");
        }
    } catch (e: any) {
        error = e.message || (lang === "es" ? "Error al procesar formulario" : "Error processing form");
    }
}
---

<Layout title="Nueva Cuenta - Presupuesto">
    <div class="w-full max-w-md md:max-w-4xl lg:max-w-6xl mx-auto  bg-slate-50 flex flex-col ">
        <!-- Header -->
        <header class="bg-primary-600 text-white pt-12 pb-6 px-6 rounded-b-3xl shadow-md">
            <div class="flex items-center justify-between">
                <a href="/budget/accounts" class="text-white hover:text-primary-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
                <h1 class="text-2xl font-bold">{lang === "es" ? "Nueva Cuenta" : "New Account"}</h1>
                <div class="w-6"></div>
            </div>
        </header>

        <!-- Form -->
        <main class="px-6 py-6 flex-grow">
            {error && (
                <div class="bg-red-50 border border-red-200 rounded-xl p-4 text-red-700 mb-4">
                    <p class="font-semibold">Error</p>
                    <p class="text-sm">{error}</p>
                </div>
            )}

            {success && (
                <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-green-700 mb-4">
                    <p class="font-semibold">{lang === "es" ? "¡Cuenta creada!" : "Account created!"}</p>
                </div>
            )}

            <form method="POST" class="space-y-4">
                <!-- Account Name -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="name" class="block text-sm font-semibold text-slate-700 mb-2">
                        {lang === "es" ? "Nombre de la Cuenta *" : "Account Name *"}
                    </label>
                    <input
                        type="text"
                        id="name"
                        name="name"
                        required
                        placeholder={lang === "es" ? "Ej: Cuenta de Cheques Principal" : "e.g. Main Checking Account"}
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                </div>

                <!-- Account Type -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label class="block text-sm font-semibold text-slate-700 mb-3">
                        {lang === "es" ? "Tipo de Cuenta *" : "Account Type *"}
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative">
                            <input
                                type="radio"
                                name="type"
                                value="checking"
                                checked
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                <span class="block text-xs font-medium text-slate-700 text-center">{lang === "es" ? "Cheques" : "Checking"}</span>
                            </div>
                        </label>
                        <label class="relative">
                            <input
                                type="radio"
                                name="type"
                                value="savings"
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <span class="block text-xs font-medium text-slate-700 text-center">{lang === "es" ? "Ahorros" : "Savings"}</span>
                            </div>
                        </label>
                        <label class="relative">
                            <input
                                type="radio"
                                name="type"
                                value="credit"
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                                <span class="block text-xs font-medium text-slate-700 text-center">{lang === "es" ? "Crédito" : "Credit"}</span>
                            </div>
                        </label>
                        <label class="relative">
                            <input
                                type="radio"
                                name="type"
                                value="investment"
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                                </svg>
                                <span class="block text-xs font-medium text-slate-700 text-center">{lang === "es" ? "Inversión" : "Investment"}</span>
                            </div>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="relative">
                            <input
                                type="radio"
                                name="type"
                                value="other"
                                class="peer sr-only"
                            />
                            <div class="border-2 border-slate-200 rounded-lg p-3 cursor-pointer peer-checked:border-primary-500 peer-checked:bg-primary-50 transition text-center">
                                <span class="text-sm font-medium text-slate-700">{lang === "es" ? "Otra" : "Other"}</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Budget Status -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input
                            type="checkbox"
                            name="offbudget"
                            class="w-5 h-5 text-primary-600 border-slate-300 rounded focus:ring-2 focus:ring-primary-500 mt-0.5"
                        />
                        <div class="flex-1">
                            <span class="block text-sm font-medium text-slate-700">
                                {lang === "es" ? "Cuenta fuera del presupuesto" : "Off-budget account"}
                            </span>
                            <span class="block text-xs text-slate-500 mt-1">
                                {lang === "es" ? "Las transacciones de esta cuenta no afectarán tu presupuesto mensual" : "Transactions in this account won't affect your monthly budget"}
                            </span>
                        </div>
                    </label>
                </div>

                <!-- Notes -->
                <div class="bg-white rounded-xl p-4 shadow-sm">
                    <label for="notes" class="block text-sm font-semibold text-slate-700 mb-2">
                        {lang === "es" ? "Notas" : "Notes"}
                    </label>
                    <textarea
                        id="notes"
                        name="notes"
                        rows="3"
                        placeholder={lang === "es" ? "Información adicional sobre esta cuenta..." : "Additional information about this account..."}
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    ></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3 pt-4">
                    <a
                        href="/budget/accounts"
                        class="flex-1 bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-semibold hover:bg-slate-300 transition text-center"
                    >
                        {lang === "es" ? "Cancelar" : "Cancel"}
                    </a>
                    <button
                        type="submit"
                        class="flex-1 bg-primary-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-primary-700 transition"
                    >
                        {lang === "es" ? "Crear Cuenta" : "Create Account"}
                    </button>
                </div>
            </form>
        </main>

        <BottomNav active="parent" role={user.role} lang={lang} />
    </div>
</Layout>

<script>
    // Focus name field on load
    document.addEventListener('DOMContentLoaded', () => {
        const nameInput = document.getElementById('name') as HTMLInputElement;
        nameInput?.focus();
    });
</script>
