---
/**
 * AssignFundsModal Component
 * Modal for explicitly assigning funds from "Ready to Assign" to category budgets
 * Similar to Actual Budget's "To Be Budgeted" workflow
 * 
 * Props:
 * - readyToAssign: number - amount available to assign
 * - categories: any[] - flattened list of all categories with groupName
 * - lang: 'en' | 'es' - language code
 * - t: translation function
 * - formatCurrency: currency formatter function
 * - baseRoute?: string - for open/close trigger IDs
 */

interface Props {
    readyToAssign: number;
    categories: any[];
    lang: 'en' | 'es';
    t: (lang: string, key: string) => string;
    formatCurrency: (amount: number) => string;
    baseRoute?: string;
}

const {
    readyToAssign,
    categories,
    lang,
    t,
    formatCurrency,
    baseRoute = 'assign-funds'
} = Astro.props;
---

<div id={`${baseRoute}-modal`} class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
        <div class="bg-primary-600 text-white px-6 py-4 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">
                    {lang === "es" ? "Asignar Fondos" : "Assign Funds"}
                </h2>
                <button id={`${baseRoute}-close-btn`} class="text-white hover:text-primary-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6 space-y-4">
            <!-- Ready to Assign Balance Display -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                <p class="text-xs text-blue-600 font-semibold mb-1 uppercase tracking-wider">
                    {t(lang, 'fin_ready_to_assign')}
                </p>
                <p class="text-2xl font-bold text-blue-700" id={`${baseRoute}-available-display`}>
                    {formatCurrency(readyToAssign)}
                </p>
            </div>

            <!-- Category Selection -->
            <div>
                <label class="block text-xs font-semibold text-slate-700 mb-2">
                    {lang === "es" ? "Seleccionar Categoría" : "Select Category"}
                </label>
                <select id={`${baseRoute}-category-select`} class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                    <option value="">{lang === "es" ? "Elegir categoría..." : "Choose a category..."}</option>
                    {categories.map(cat => (
                        <option value={cat.id}>
                            {cat.groupName} → {cat.name}
                        </option>
                    ))}
                </select>
            </div>

            <!-- Amount Input -->
            <div>
                <label class="block text-xs font-semibold text-slate-700 mb-2">
                    {lang === "es" ? "Cantidad a Asignar" : "Amount to Assign"}
                </label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">$</span>
                    <input
                        type="number"
                        id={`${baseRoute}-amount-input`}
                        step="0.01"
                        min="0.01"
                        placeholder="0.00"
                        class="w-full pl-7 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                </div>
            </div>

            <!-- Quick Preset Amounts -->
            {readyToAssign > 0 && (
                <div class="space-y-2">
                    <p class="text-xs font-semibold text-slate-600">
                        {lang === "es" ? "Cantidad Rápida" : "Quick Amounts"}
                    </p>
                    <div class="grid grid-cols-3 gap-2">
                        {[25, 50, 100].filter(amt => amt < readyToAssign).map(amt => (
                            <button
                                type="button"
                                class={`${baseRoute}-quick-amount px-3 py-2 rounded-lg text-sm font-semibold transition border border-slate-300 hover:border-primary-500 hover:text-primary-600`}
                                data-amount={amt}
                            >
                                ${amt}
                            </button>
                        ))}
                        <button
                            type="button"
                            class={`${baseRoute}-quick-amount px-3 py-2 rounded-lg text-sm font-semibold transition border border-slate-300 hover:border-primary-500 hover:text-primary-600`}
                            data-amount="all"
                            title={lang === "es" ? "Asignar todo" : "Assign all"}
                        >
                            {lang === "es" ? "Todo" : "All"}
                        </button>
                    </div>
                </div>
            )}

            <!-- Error Display -->
            <div id={`${baseRoute}-error`} class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm"></div>

            <!-- Success Display -->
            <div id={`${baseRoute}-success`} class="hidden bg-green-50 border border-green-200 rounded-lg p-3 text-green-700 text-sm">
                {lang === "es" ? "Fondos asignados exitosamente" : "Funds assigned successfully"}
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 pt-2">
                <button id={`${baseRoute}-cancel-btn`} class="flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-semibold hover:bg-slate-300 transition text-sm">
                    {lang === "es" ? "Cancelar" : "Cancel"}
                </button>
                <button id={`${baseRoute}-confirm-btn`} class="flex-1 bg-primary-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-700 transition text-sm">
                    {lang === "es" ? "Asignar" : "Assign"}
                </button>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ readyToAssign, baseRoute, lang }}>
    // Quick amount button handlers
    document.querySelectorAll(`.${baseRoute}-quick-amount`).forEach(btn => {
        btn.addEventListener('click', () => {
            const amount = btn.dataset.amount;
            const amountInput = document.getElementById(`${baseRoute}-amount-input`);
            if (amount === 'all') {
                amountInput.value = readyToAssign;
            } else {
                amountInput.value = parseFloat(amount);
            }
            amountInput.focus();
        });
    });

    // Cancel button
    document.getElementById(`${baseRoute}-cancel-btn`)?.addEventListener('click', () => {
        document.getElementById(`${baseRoute}-modal`).classList.add('hidden');
    });

    // Confirm button — POST to /api/budget/allocations/set via proxy
    document.getElementById(`${baseRoute}-confirm-btn`)?.addEventListener('click', async () => {
        const categorySelect = document.getElementById(`${baseRoute}-category-select`);
        const amountInput = document.getElementById(`${baseRoute}-amount-input`);
        const errorEl = document.getElementById(`${baseRoute}-error`);
        const successEl = document.getElementById(`${baseRoute}-success`);
        const confirmBtn = document.getElementById(`${baseRoute}-confirm-btn`);
        const availableDisplay = document.getElementById(`${baseRoute}-available-display`);

        const categoryId = categorySelect?.value;
        const amountRaw = parseFloat(amountInput?.value || '');
        const amountCents = Math.round(amountRaw * 100);

        errorEl?.classList.add('hidden');
        successEl?.classList.add('hidden');

        if (!categoryId) {
            if (errorEl) { errorEl.textContent = lang === 'es' ? 'Selecciona una categoría' : 'Please select a category'; errorEl.classList.remove('hidden'); }
            return;
        }
        if (isNaN(amountCents) || amountCents <= 0) {
            if (errorEl) { errorEl.textContent = lang === 'es' ? 'Ingresa una cantidad válida' : 'Please enter a valid amount'; errorEl.classList.remove('hidden'); }
            return;
        }

        confirmBtn.disabled = true;
        try {
            // Get current month from page URL: /parent/finances/month/YYYY/MM
            const parts = window.location.pathname.split('/');
            const yearIdx = parts.indexOf('month') + 1;
            const monthStr = yearIdx > 0
                ? `${parts[yearIdx]}-${String(parts[yearIdx + 1]).padStart(2, '0')}-01`
                : new Date().toISOString().slice(0, 7) + '-01';

            const res = await fetch('/api/budget/allocations/set', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_id: categoryId, month: monthStr, amount: amountCents })
            });

            if (!res.ok) {
                const data = await res.json().catch(() => ({}));
                throw new Error(data.detail || data.message || (lang === 'es' ? 'Error al asignar fondos' : 'Failed to assign funds'));
            }

            successEl?.classList.remove('hidden');
            if (amountInput) amountInput.value = '';
            if (categorySelect) categorySelect.value = '';

            setTimeout(() => { window.location.reload(); }, 800);
        } catch (err) {
            if (errorEl) { errorEl.textContent = err.message; errorEl.classList.remove('hidden'); }
            confirmBtn.disabled = false;
        }
    });

    // Close button
    document.getElementById(`${baseRoute}-close-btn`)?.addEventListener('click', () => {
        document.getElementById(`${baseRoute}-modal`).classList.add('hidden');
    });

    // Clear error/success messages when user edits
    const inputs = [
        document.getElementById(`${baseRoute}-category-select`),
        document.getElementById(`${baseRoute}-amount-input`)
    ];
    inputs.forEach(input => {
        input?.addEventListener('input', () => {
            document.getElementById(`${baseRoute}-error`)?.classList.add('hidden');
            document.getElementById(`${baseRoute}-success`)?.classList.add('hidden');
        });
    });

    // Pill buttons: open modal pre-selecting the clicked category
    function openAssignModal(categoryId) {
        const modal = document.getElementById(`${baseRoute}-modal`);
        const categorySelect = document.getElementById(`${baseRoute}-category-select`);
        const amountInput = document.getElementById(`${baseRoute}-amount-input`);
        const errorEl = document.getElementById(`${baseRoute}-error`);
        const successEl = document.getElementById(`${baseRoute}-success`);
        const confirmBtn = document.getElementById(`${baseRoute}-confirm-btn`);

        if (categoryId && categorySelect) categorySelect.value = categoryId;
        if (amountInput) amountInput.value = '';
        errorEl?.classList.add('hidden');
        successEl?.classList.add('hidden');
        if (confirmBtn) confirmBtn.disabled = false;

        modal?.classList.remove('hidden');
        amountInput?.focus();
    }

    document.querySelectorAll('.assign-pill-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            openAssignModal(btn.dataset.categoryId);
        });
    });

    // Also handle the global open-assign-funds-modal button (header button)
    document.getElementById('open-assign-funds-modal')?.addEventListener('click', () => {
        openAssignModal(null);
    });
</script>
